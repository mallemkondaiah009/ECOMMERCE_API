<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Secure user login form for accessing your account.">
    <title>Login - Sign In to Your Account</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .notification {
            animation: slideIn 0.4s ease-out, slideOut 0.5s ease-in 4.5s forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideOut {
            to { opacity: 0; transform: translateY(-20px); }
        }
        .input-focus-ring {
            transition: all 0.2s;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center min-h-screen p-4">

    <!-- Notification Toast Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-3 pointer-events-none">
        <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-5 py-4 rounded-xl shadow-xl notification pointer-events-auto flex items-center gap-3 max-w-sm">
            <i class="fas fa-exclamation-circle text-xl"></i>
            <span></span>
        </div>
        <div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-700 px-5 py-4 rounded-xl shadow-xl notification pointer-events-auto flex items-center gap-3 max-w-sm">
            <i class="fas fa-check-circle text-xl"></i>
            <span>Login successful! Redirecting...</span>
        </div>
    </div>

    <!-- Login Form -->
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all hover:scale-[1.01]">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Welcome Back</h1>
            <p class="text-gray-600 mt-2">Sign in to continue to your account</p>
        </div>

        <form id="login-form" novalidate autocomplete="on">
            {% csrf_token %}

            <div class="mb-6">
                <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-envelope text-gray-400"></i>
                    </div>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="pl-10 pr-4 py-3 w-full border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50 input-focus-ring" 
                        placeholder="you@example.com" 
                        required 
                        autocomplete="email"
                        autofocus>
                </div>
                <p id="email-error" class="text-red-600 text-sm mt-2 hidden"></p>
            </div>

            <div class="mb-6">
                <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-lock text-gray-400"></i>
                    </div>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        class="pl-10 pr-12 py-3 w-full border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50 input-focus-ring" 
                        placeholder="••••••••" 
                        required 
                        autocomplete="current-password">
                    <button 
                        type="button" 
                        id="toggle-password" 
                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 focus:outline-none"
                        aria-label="Show password">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <p id="password-error" class="text-red-600 text-sm mt-2 hidden"></p>
            </div>

            <button 
                type="submit" 
                id="submit-btn"
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-4 rounded-xl shadow-lg hover:shadow-xl transform transition-all duration-200 flex items-center justify-center gap-3 disabled:opacity-70 disabled:cursor-not-allowed">
                <span>Sign In</span>
                <svg id="spinner" class="hidden h-5 w-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
                </svg>
            </button>
        </form>

        <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
                Don't have an account? 
                <a href="/register" class="font-semibold text-blue-600 hover:text-blue-800 underline-offset-2 hover:underline">
                    Register here
                </a>
            </p>
        </div>
    </div>

    <script>
        // CSRF Token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // DOM Elements
        const form = document.getElementById('login-form');
        const submitBtn = document.getElementById('submit-btn');
        const spinner = document.getElementById('spinner');
        const btnText = submitBtn.querySelector('span');
        const errorToast = document.getElementById('error-message');
        const successToast = document.getElementById('success-message');
        const errorSpan = errorToast.querySelector('span');
        const emailError = document.getElementById('email-error');
        const passwordError = document.getElementById('password-error');
        const passwordInput = document.getElementById('password');
        const togglePassword = document.getElementById('toggle-password');
        const toggleIcon = togglePassword.querySelector('i');

        // Toggle Password Visibility
        togglePassword.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            toggleIcon.className = isPassword ? 'fas fa-eye-slash' : 'fas fa-eye';
            togglePassword.setAttribute('aria-label', isPassword ? 'Hide password' : 'Show password');
        });

        // Clear all errors/toasts
        function clearErrors() {
            errorToast.classList.add('hidden');
            successToast.classList.add('hidden');
            emailError.classList.add('hidden');
            passwordError.classList.add('hidden');
            emailError.textContent = '';
            passwordError.textContent = '';
        }

        // Show toast
        function showToast(type, message) {
            clearErrors();
            const toast = type === 'success' ? successToast : errorToast;
            const span = type === 'success' ? successToast.querySelector('span') : errorSpan;
            span.textContent = message;
            toast.classList.remove('hidden');
        }

        // Main Form Submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors();

            const email = form.email.value.trim();
            const password = form.password.value;

            // Client-side validation
            if (!email || !password) {
                showToast('error', 'Please fill in all fields.');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                emailError.textContent = 'Please enter a valid email address.';
                emailError.classList.remove('hidden');
                form.email.focus();
                return;
            }

            // Loading state
            submitBtn.disabled = true;
            btnText.classList.add('opacity-0');
            spinner.classList.remove('hidden');

            try {
                const response = await fetch('https://hakart.onrender.com/api/auth/user-login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });

                // Check if response is actually JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // Server returned HTML → log for debugging
                    const htmlSnippet = await response.text();
                    console.error('Server returned HTML instead of JSON:', htmlSnippet.substring(0, 500));

                    if (response.status === 403) {
                        showToast('error', 'CSRF token missing or invalid.');
                    } else if (response.status === 401) {
                        showToast('error', 'Invalid email or password.');
                    } else if (response.status === 404) {
                        showToast('error', 'Login endpoint not found (404).');
                    } else if (response.status >= 500) {
                        showToast('error', 'Server error. Please try again later.');
                    } else {
                        showToast('error', 'Unexpected response from server.');
                    }
                    return;
                }

                // Safe to parse JSON now
                const data = await response.json();

                if (response.ok) {
                    showToast('success', data.message || 'Login successful! Redirecting...');
                    setTimeout(() => {
                        window.location.href = data.redirect || '/';
                    }, 1500);
                } else {
                    // Handle API error responses
                    if (data.email) {
                        emailError.textContent = Array.isArray(data.email) ? data.email[0] : data.email;
                        emailError.classList.remove('hidden');
                    }
                    if (data.password) {
                        passwordError.textContent = Array.isArray(data.password) ? data.password[0] : data.password;
                        passwordError.classList.remove('hidden');
                    }
                    if (data.non_field_errors) {
                        showToast('error', data.non_field_errors[0]);
                    } else if (data.detail) {
                        showToast('error', data.detail);
                    } else if (data.error) {
                        showToast('error', data.error);
                    } else {
                        showToast('error', 'Invalid email or password.');
                    }
                }

            } catch (err) {
                console.error('Network or unexpected error:', err);
                showToast('error', 'Connection failed. Please check your internet and try again.');
            } finally {
                // Always reset button
                submitBtn.disabled = false;
                btnText.classList.remove('opacity-0');
                spinner.classList.add('hidden');
            }
        });

        // Optional: Submit on Enter in password field
        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                form.dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>